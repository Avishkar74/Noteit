<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snabby ‚Äì Upload</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0F0F0F;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .container {
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #fff;
    }
    .subtitle {
      font-size: 13px;
      color: #777;
      margin-bottom: 16px;
    }
    /* Timer bar */
    .timer-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px 16px;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 600;
      transition: border-color 0.3s, background 0.3s;
    }
    .timer-bar.warning {
      border-color: #F59E0B;
      background: rgba(245,158,11,0.08);
    }
    .timer-bar.expired {
      border-color: #DC2626;
      background: rgba(220,38,38,0.08);
    }
    .timer-icon { font-size: 16px; }
    .timer-text { color: #fff; }
    .timer-text .time { color: #22C55E; font-variant-numeric: tabular-nums; }
    .timer-bar.warning .time { color: #F59E0B; }
    .timer-bar.expired .time { color: #DC2626; }
    /* Rate limit notice */
    .rate-notice {
      font-size: 11px;
      color: #555;
      margin-bottom: 20px;
    }
    .upload-area {
      border: 2px dashed #333;
      border-radius: 16px;
      padding: 40px 20px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 16px;
      background: #1A1A1A;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: #fff;
      background: rgba(255,255,255,0.03);
    }
    .upload-area svg { margin-bottom: 12px; }
    .upload-area p {
      font-size: 14px;
      color: #aaa;
    }
    .upload-area .hint {
      font-size: 11px;
      color: #555;
      margin-top: 8px;
    }
    input[type="file"] { display: none; }
    .btn {
      display: inline-block;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 12px;
      transition: background 0.15s;
    }
    .btn:hover { background: #f0f0f0; }
    .btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .status {
      font-size: 13px;
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
    }
    .status--success { background: rgba(34,197,94,0.1); color: #22C55E; }
    .status--error { background: rgba(220,38,38,0.1); color: #DC2626; }
    .status--warning { background: rgba(245,158,11,0.1); color: #F59E0B; }
    .mascot-logo {
      margin: 0 auto 16px;
    }
    .upload-counter {
      background: rgba(255,255,255,0.05);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 12px;
      margin-top: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #aaa;
    }
    .upload-counter span { color: #fff; }
    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .btn-row .btn {
      flex: 1;
      margin-bottom: 0;
    }
    .btn--secondary {
      background: #1A1A1A;
      color: #fff;
      border: 1px solid #333;
    }
    .btn--secondary:hover {
      background: #222;
    }
    /* Overlay states */
    .overlay-msg {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }
    .overlay-msg.visible { display: block; }
    .overlay-msg h2 { font-size: 18px; margin-bottom: 8px; }
    .overlay-msg p { color: #777; font-size: 13px; line-height: 1.6; }
    .overlay-msg .icon { font-size: 40px; margin-bottom: 16px; }
    .upload-content { transition: opacity 0.3s; }
    .upload-content.disabled { opacity: 0.4; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Mascot SVG matching extension branding -->
    <div class="mascot-logo">
      <svg viewBox="0 0 48 48" width="48" height="48">
        <circle cx="24" cy="24" r="18" fill="#000" stroke="#ffffff" stroke-width="1.2"/>
        <circle cx="24" cy="24" r="20" fill="none" stroke="#ffffff" stroke-width="1.5" opacity="0.3"/>
        <ellipse cx="19" cy="22" rx="3.5" ry="4.2" fill="white"/>
        <ellipse cx="29" cy="22" rx="3.5" ry="4.2" fill="white"/>
        <circle cx="19" cy="22" r="1.5" fill="#000"/>
        <circle cx="29" cy="22" r="1.5" fill="#000"/>
      </svg>
    </div>
    <h1>Snabby</h1>
    <p class="subtitle">Upload photos to your active session</p>

    <!-- Timer -->
    <div class="timer-bar" id="timerBar">
      <span class="timer-icon">‚è±Ô∏è</span>
      <span class="timer-text">Time remaining: <span class="time" id="timerText">3:00</span></span>
    </div>

    <p class="rate-notice">Max 60 images per minute ¬∑ JPG, PNG, WEBP ¬∑ 10MB each</p>

    <!-- Session ended overlay -->
    <div class="overlay-msg" id="sessionEnded">
      <div class="icon">üîí</div>
      <h2>Session Ended</h2>
      <p>This upload session has been closed from the extension.<br>You can close this tab.</p>
    </div>

    <!-- Upload window expired overlay -->
    <div class="overlay-msg" id="windowExpired">
      <div class="icon">‚è∞</div>
      <h2>Upload Window Expired</h2>
      <p>The 3-minute upload window has ended.<br>Scan the QR code again from the extension to continue uploading.</p>
    </div>

    <div class="upload-content" id="uploadContent">
      <div class="upload-area" id="dropZone">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
          <path d="M24 8v24M16 16l8-8 8 8" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
          <path d="M8 32v4a4 4 0 004 4h24a4 4 0 004-4v-4" stroke="#555" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <p>Tap to choose from gallery</p>
        <p class="hint">Multiple selection supported</p>
      </div>

      <input type="file" id="galleryInput" accept="image/jpeg,image/png,image/webp" multiple />
      <input type="file" id="cameraInput" accept="image/jpeg,image/png,image/webp" capture="environment" />

      <div class="btn-row">
        <button class="btn" id="galleryBtn">üñºÔ∏è Gallery</button>
        <button class="btn btn--secondary" id="cameraBtn">üì∑ Camera</button>
      </div>

      <div class="upload-counter" id="uploadCounter" style="display:none">
        <span id="counterText">0</span> photo(s) uploaded
      </div>
      <div class="status" id="status" style="display:none"></div>
    </div>
  </div>

  <script>
    const sessionId = window.location.pathname.split('/').pop();
    const urlParams = new URLSearchParams(window.location.search);
    const uploadToken = urlParams.get('token') || '';
    const dropZone = document.getElementById('dropZone');
    const galleryInput = document.getElementById('galleryInput');
    const cameraInput = document.getElementById('cameraInput');
    const galleryBtn = document.getElementById('galleryBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const uploadCounter = document.getElementById('uploadCounter');
    const counterText = document.getElementById('counterText');
    const status = document.getElementById('status');
    const uploadContent = document.getElementById('uploadContent');
    const sessionEnded = document.getElementById('sessionEnded');
    const windowExpired = document.getElementById('windowExpired');
    const timerBar = document.getElementById('timerBar');
    const timerText = document.getElementById('timerText');
    let totalUploads = 0;
    let sessionValid = true;
    let uploadWindowOpen = true;
    let uploadExpiresAt = Date.now() + 3 * 60 * 1000; // fallback

    dropZone.addEventListener('click', () => galleryInput.click());
    galleryBtn.addEventListener('click', () => galleryInput.click());
    cameraBtn.addEventListener('click', () => cameraInput.click());

    galleryInput.addEventListener('change', handleFiles);
    cameraInput.addEventListener('change', handleFiles);

    // Drag & drop
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFileList(e.dataTransfer.files);
    });

    async function handleFiles(e) {
      await handleFileList(e.target.files);
      e.target.value = '';
    }

    async function handleFileList(fileList) {
      const files = Array.from(fileList);
      if (files.length === 0) return;

      if (!uploadWindowOpen) {
        showStatus('Upload window expired. Scan QR code again.', 'error');
        return;
      }

      for (let i = 0; i < files.length; i++) {
        if (!sessionValid) {
          showStatus('Session ended. Uploads disabled.', 'error');
          return;
        }
        if (!uploadWindowOpen) {
          showStatus('Upload window expired. Remaining images not uploaded.', 'warning');
          return;
        }
        showStatus(`Uploading ${i + 1} of ${files.length}...`, '');
        await uploadFile(files[i]);
      }
    }

    async function uploadFile(file) {
      if (!sessionValid || !uploadWindowOpen) {
        showStatus('Uploads disabled.', 'error');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        showStatus('File too large. Max 10MB per photo.', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('image', file);

      try {
        const res = await fetch(`/api/upload/${sessionId}`, {
          method: 'POST',
          headers: { 'X-Upload-Token': uploadToken },
          body: formData,
        });
        const data = await res.json();
        if (res.ok && data.success) {
          totalUploads = data.imageCount;
          updateCounter();
          showStatus(`‚úì Uploaded! (${totalUploads} total)`, 'success');
        } else {
          if (res.status === 404) {
            markSessionEnded();
          } else if (res.status === 403 && data.error && data.error.includes('window expired')) {
            markWindowExpired();
          } else if (res.status === 429) {
            showStatus('Rate limit reached (40/min). Wait a moment and try again.', 'warning');
          } else {
            showStatus(data.error || 'Upload failed.', 'error');
          }
        }
      } catch {
        showStatus('Upload failed. Check your connection.', 'error');
      }
    }

    function updateCounter() {
      uploadCounter.style.display = 'block';
      counterText.textContent = totalUploads;
    }

    function showStatus(msg, type) {
      if (!msg) { status.style.display = 'none'; return; }
      status.textContent = msg;
      status.className = type ? `status status--${type}` : 'status';
      status.style.display = 'block';
    }

    function markSessionEnded() {
      sessionValid = false;
      uploadContent.classList.add('disabled');
      sessionEnded.classList.add('visible');
      timerBar.style.display = 'none';
      clearInterval(validityTimer);
      clearInterval(countdownTimer);
    }

    function markWindowExpired() {
      uploadWindowOpen = false;
      uploadContent.classList.add('disabled');
      windowExpired.classList.add('visible');
      timerBar.classList.add('expired');
      timerText.textContent = '0:00';
      clearInterval(countdownTimer);
    }

    // Countdown timer
    const countdownTimer = setInterval(() => {
      const remaining = uploadExpiresAt - Date.now();
      if (remaining <= 0) {
        markWindowExpired();
        return;
      }
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      // Warning when < 30 seconds
      if (remaining < 30000) {
        timerBar.classList.add('warning');
      }
    }, 1000);

    // Poll session validity every 30 seconds (socket.io handles instant close events)
    const validityTimer = setInterval(async () => {
      if (!sessionValid) return;
      try {
        const res = await fetch(`/api/session/${sessionId}/valid`);
        if (res.ok) {
          const data = await res.json();
          if (!data.valid) {
            markSessionEnded();
          } else if (data.uploadWindowOpen === false) {
            // Extension closed uploads (session still exists but uploads blocked)
            markWindowExpired();
          }
        }
      } catch { /* network error, retry next interval */ }
    }, 30000);

    // Socket.io for instant session-end notification
    (function connectSocket() {
      try {
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        script.onload = function() {
          try {
            const socket = io({ query: { sessionId } });
            socket.on('uploads-closed', () => {
              markWindowExpired();
            });
          } catch(e) { /* Socket.io optional */ }
        };
        document.head.appendChild(script);
      } catch(e) { /* Socket.io optional */ }
    })();

    // Fetch session info on load to get uploadExpiresAt
    (async () => {
      try {
        const res = await fetch(`/api/session/${sessionId}`);
        if (res.ok) {
          const data = await res.json();
          if (data.uploadExpiresAt) {
            uploadExpiresAt = data.uploadExpiresAt;
            // Check if already expired
            if (Date.now() >= uploadExpiresAt) {
              markWindowExpired();
            }
          }
        } else {
          markSessionEnded();
        }
      } catch { /* ignore */ }

      // Also check validity
      try {
        const res = await fetch(`/api/session/${sessionId}/valid`);
        if (res.ok) {
          const data = await res.json();
          if (!data.valid) markSessionEnded();
        }
      } catch { /* ignore */ }
    })();
  </script>
</body>
</html>
